<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üå∏ Pop Music Player</title>
  <style>
    body {
      background: linear-gradient(135deg, #fdfbfb, #ebedee);
      color: #333;
      font-family: "Segoe UI", "Helvetica Neue", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    h1 {
      margin: 10px 0 20px;
      font-size: 2rem;
      color: #ff4081;
    }
    .player {
      background: #fff;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 500px;
      border: 2px solid #ffe0f0;
    }
    .controls {
      display: flex;
      justify-content: center;
      margin: 15px 0;
    }
    .controls button {
      margin: 0 8px;
      padding: 12px 15px;
      border: none;
      border-radius: 50%;
      background: #ff80ab;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
    }
    .controls button:hover {
      background: #ff4081;
      transform: scale(1.1);
    }
    input[type="range"] {
      width: 100%;
      margin: 10px 0;
      accent-color: #ff4081;
    }
    .eq-controls {
      margin: 15px 0;
      text-align: center;
    }
    .eq-controls label {
      font-size: 0.9rem;
      margin: 0 5px;
    }
    canvas {
      margin-top: 20px;
      background: #fce4ec;
      width: 100%;
      height: 120px;
      border-radius: 15px;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 10px 0 0;
      max-height: 150px;
      overflow-y: auto;
    }
    li {
      padding: 8px;
      border-bottom: 1px solid #f8bbd0;
      cursor: pointer;
      transition: background 0.2s;
    }
    li:hover {
      background: #fce4ec;
    }
    li.active {
      color: #ff4081;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üå∏ Pop Music Player</h1>

  <div class="player">
    <!-- „Éï„Ç°„Ç§„É´ÈÅ∏Êäû -->
    <input type="file" id="fileInput" multiple accept="audio/*" />

    <!-- ÂÜçÁîü„Ç≥„É≥„Éà„É≠„Éº„É´ -->
    <div class="controls">
      <button id="prev">‚èÆ</button>
      <button id="play">‚ñ∂</button>
      <button id="next">‚è≠</button>
      <button id="shuffle">üîÄ</button>
      <button id="loop">üîÅ</button>
    </div>

    <!-- „Ç∑„Éº„ÇØ„Éê„Éº -->
    <input type="range" id="seekBar" value="0" step="1"/>

    <!-- Èü≥Èáè -->
    <label>üîä</label>
    <input type="range" id="volume" min="0" max="1" step="0.01" value="1"/>

    <!-- „Ç§„Ç≥„É©„Ç§„Ç∂„Éº -->
    <div class="eq-controls">
      <label>Bass</label>
      <input type="range" id="bass" min="-30" max="30" value="0"/>
      <label>Mid</label>
      <input type="range" id="mid" min="-30" max="30" value="0"/>
      <label>Treble</label>
      <input type="range" id="treble" min="-30" max="30" value="0"/>
    </div>

    <!-- „Éó„É¨„Ç§„É™„Çπ„Éà -->
    <h3>üìú Playlist</h3>
    <ul id="playlist"></ul>

    <!-- „Éì„Ç∏„É•„Ç¢„É©„Ç§„Ç∂„Éº -->
    <canvas id="visualizer"></canvas>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const playlistEl = document.getElementById("playlist");
    const playBtn = document.getElementById("play");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    const shuffleBtn = document.getElementById("shuffle");
    const loopBtn = document.getElementById("loop");
    const seekBar = document.getElementById("seekBar");
    const volumeControl = document.getElementById("volume");

    const bassControl = document.getElementById("bass");
    const midControl = document.getElementById("mid");
    const trebleControl = document.getElementById("treble");

    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let audio = new Audio();
    let trackList = [];
    let currentTrack = 0;
    let isPlaying = false;
    let isLoop = false;
    let isShuffle = false;

    let sourceNode;
    const gainNode = audioCtx.createGain();
    const analyser = audioCtx.createAnalyser();

    const bassEQ = audioCtx.createBiquadFilter();
    bassEQ.type = "lowshelf";
    bassEQ.frequency.value = 200;

    const midEQ = audioCtx.createBiquadFilter();
    midEQ.type = "peaking";
    midEQ.Q.value = 1;
    midEQ.frequency.value = 1000;

    const trebleEQ = audioCtx.createBiquadFilter();
    trebleEQ.type = "highshelf";
    trebleEQ.frequency.value = 3000;

    function connectNodes() {
      if (sourceNode) sourceNode.disconnect();
      sourceNode = audioCtx.createMediaElementSource(audio);
      sourceNode.connect(bassEQ);
      bassEQ.connect(midEQ);
      midEQ.connect(trebleEQ);
      trebleEQ.connect(gainNode);
      gainNode.connect(analyser);
      analyser.connect(audioCtx.destination);
    }
    connectNodes();

    fileInput.addEventListener("change", (e) => {
      trackList = Array.from(e.target.files);
      renderPlaylist();
      loadTrack(0);
    });

    function renderPlaylist() {
      playlistEl.innerHTML = "";
      trackList.forEach((file, index) => {
        const li = document.createElement("li");
        li.textContent = file.name;
        if (index === currentTrack) li.classList.add("active");
        li.addEventListener("click", () => {
          loadTrack(index);
          playAudio();
        });
        playlistEl.appendChild(li);
      });
    }

    function loadTrack(index) {
      currentTrack = index;
      audio.src = URL.createObjectURL(trackList[index]);
      seekBar.value = 0;
      renderPlaylist();
    }

    function playAudio() {
      audio.play();
      audioCtx.resume();
      isPlaying = true;
      playBtn.textContent = "‚è∏";
    }

    function pauseAudio() {
      audio.pause();
      isPlaying = false;
      playBtn.textContent = "‚ñ∂";
    }

    playBtn.addEventListener("click", () => {
      if (!trackList.length) return;
      if (isPlaying) pauseAudio(); else playAudio();
    });

    prevBtn.addEventListener("click", () => {
      if (!trackList.length) return;
      currentTrack = (currentTrack - 1 + trackList.length) % trackList.length;
      loadTrack(currentTrack);
      playAudio();
    });

    nextBtn.addEventListener("click", () => {
      if (!trackList.length) return;
      if (isShuffle) {
        currentTrack = Math.floor(Math.random() * trackList.length);
      } else {
        currentTrack = (currentTrack + 1) % trackList.length;
      }
      loadTrack(currentTrack);
      playAudio();
    });

    shuffleBtn.addEventListener("click", () => {
      isShuffle = !isShuffle;
      shuffleBtn.style.background = isShuffle ? "#ff9800" : "#ff80ab";
    });

    loopBtn.addEventListener("click", () => {
      isLoop = !isLoop;
      loopBtn.style.background = isLoop ? "#ff9800" : "#ff80ab";
    });

    audio.addEventListener("ended", () => {
      if (isLoop) {
        playAudio();
      } else {
        nextBtn.click();
      }
    });

    audio.addEventListener("timeupdate", () => {
      seekBar.max = audio.duration || 0;
      seekBar.value = audio.currentTime;
    });

    seekBar.addEventListener("input", () => {
      audio.currentTime = seekBar.value;
    });

    volumeControl.addEventListener("input", () => {
      gainNode.gain.value = volumeControl.value;
    });

    bassControl.addEventListener("input", () => {
      bassEQ.gain.value = bassControl.value;
    });
    midControl.addEventListener("input", () => {
      midEQ.gain.value = midControl.value;
    });
    trebleControl.addEventListener("input", () => {
      trebleEQ.gain.value = trebleControl.value;
    });

    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");
    analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);

    function draw() {
      requestAnimationFrame(draw);
      analyser.getByteFrequencyData(dataArray);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const barWidth = (canvas.width / bufferLength) * 2.5;
      let x = 0;
      for (let i = 0; i < bufferLength; i++) {
        const barHeight = dataArray[i];
        const r = 255 - i;
        const g = 100 + (i % 100);
        const b = 150 + (barHeight % 100);
        ctx.fillStyle = `rgb(${r},${g},${b})`;
        ctx.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);
        x += barWidth + 1;
      }
    }
    draw();
  </script>
</body>
</html>
