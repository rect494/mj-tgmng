<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🎵 Full Music Player</title>
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .controls button {
      margin: 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background: #1db954;
      color: #fff;
      cursor: pointer;
    }
    .controls button:hover {
      background: #1ed760;
    }
    input[type="range"] {
      width: 200px;
    }
    canvas {
      margin-top: 20px;
      background: #000;
      width: 100%;
      height: 150px;
      border-radius: 10px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      padding: 5px;
      cursor: pointer;
    }
    li:hover {
      background: #333;
    }
  </style>
</head>
<body>
  <h1>🎶 Music Player</h1>

  <!-- ファイル選択 -->
  <input type="file" id="fileInput" multiple accept="audio/*" />
  <br/><br/>

  <!-- 再生コントロール -->
  <div class="controls">
    <button id="prev">⏮ Prev</button>
    <button id="play">▶ Play</button>
    <button id="next">⏭ Next</button>
    <button id="shuffle">🔀 Shuffle</button>
    <button id="loop">🔁 Loop</button>
  </div>

  <!-- シークバー -->
  <input type="range" id="seekBar" value="0" step="1"/>
  <br/><br/>

  <!-- 音量 -->
  <label>🔊 Volume</label>
  <input type="range" id="volume" min="0" max="1" step="0.01" value="1"/>

  <!-- イコライザー -->
  <div>
    <h3>🎚 Equalizer</h3>
    <label>Bass</label>
    <input type="range" id="bass" min="-30" max="30" value="0"/>
    <label>Mid</label>
    <input type="range" id="mid" min="-30" max="30" value="0"/>
    <label>Treble</label>
    <input type="range" id="treble" min="-30" max="30" value="0"/>
  </div>

  <!-- プレイリスト -->
  <h3>📜 Playlist</h3>
  <ul id="playlist"></ul>

  <!-- ビジュアライザー -->
  <canvas id="visualizer"></canvas>

  <script>
    const fileInput = document.getElementById("fileInput");
    const playlistEl = document.getElementById("playlist");
    const playBtn = document.getElementById("play");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    const shuffleBtn = document.getElementById("shuffle");
    const loopBtn = document.getElementById("loop");
    const seekBar = document.getElementById("seekBar");
    const volumeControl = document.getElementById("volume");

    const bassControl = document.getElementById("bass");
    const midControl = document.getElementById("mid");
    const trebleControl = document.getElementById("treble");

    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let audio = new Audio();
    let trackList = [];
    let currentTrack = 0;
    let isPlaying = false;
    let isLoop = false;
    let isShuffle = false;

    // AudioNode接続
    let sourceNode;
    const gainNode = audioCtx.createGain();
    const analyser = audioCtx.createAnalyser();

    const bassEQ = audioCtx.createBiquadFilter();
    bassEQ.type = "lowshelf";
    bassEQ.frequency.value = 200;

    const midEQ = audioCtx.createBiquadFilter();
    midEQ.type = "peaking";
    midEQ.Q.value = 1;
    midEQ.frequency.value = 1000;

    const trebleEQ = audioCtx.createBiquadFilter();
    trebleEQ.type = "highshelf";
    trebleEQ.frequency.value = 3000;

    // 接続チェーン: source -> EQ -> gain -> analyser -> destination
    function connectNodes() {
      if (sourceNode) sourceNode.disconnect();
      sourceNode = audioCtx.createMediaElementSource(audio);
      sourceNode.connect(bassEQ);
      bassEQ.connect(midEQ);
      midEQ.connect(trebleEQ);
      trebleEQ.connect(gainNode);
      gainNode.connect(analyser);
      analyser.connect(audioCtx.destination);
    }
    connectNodes();

    // ファイル選択
    fileInput.addEventListener("change", (e) => {
      trackList = Array.from(e.target.files);
      renderPlaylist();
      loadTrack(0);
    });

    function renderPlaylist() {
      playlistEl.innerHTML = "";
      trackList.forEach((file, index) => {
        const li = document.createElement("li");
        li.textContent = file.name;
        li.addEventListener("click", () => {
          loadTrack(index);
          playAudio();
        });
        playlistEl.appendChild(li);
      });
    }

    function loadTrack(index) {
      currentTrack = index;
      audio.src = URL.createObjectURL(trackList[index]);
      seekBar.value = 0;
    }

    function playAudio() {
      audio.play();
      audioCtx.resume();
      isPlaying = true;
      playBtn.textContent = "⏸ Pause";
    }

    function pauseAudio() {
      audio.pause();
      isPlaying = false;
      playBtn.textContent = "▶ Play";
    }

    playBtn.addEventListener("click", () => {
      if (!trackList.length) return;
      if (isPlaying) pauseAudio(); else playAudio();
    });

    prevBtn.addEventListener("click", () => {
      if (!trackList.length) return;
      currentTrack = (currentTrack - 1 + trackList.length) % trackList.length;
      loadTrack(currentTrack);
      playAudio();
    });

    nextBtn.addEventListener("click", () => {
      if (!trackList.length) return;
      if (isShuffle) {
        currentTrack = Math.floor(Math.random() * trackList.length);
      } else {
        currentTrack = (currentTrack + 1) % trackList.length;
      }
      loadTrack(currentTrack);
      playAudio();
    });

    shuffleBtn.addEventListener("click", () => {
      isShuffle = !isShuffle;
      shuffleBtn.style.background = isShuffle ? "#ff9800" : "#1db954";
    });

    loopBtn.addEventListener("click", () => {
      isLoop = !isLoop;
      loopBtn.style.background = isLoop ? "#ff9800" : "#1db954";
    });

    audio.addEventListener("ended", () => {
      if (isLoop) {
        playAudio();
      } else {
        nextBtn.click();
      }
    });

    // シークバー
    audio.addEventListener("timeupdate", () => {
      seekBar.max = audio.duration || 0;
      seekBar.value = audio.currentTime;
    });

    seekBar.addEventListener("input", () => {
      audio.currentTime = seekBar.value;
    });

    // 音量
    volumeControl.addEventListener("input", () => {
      gainNode.gain.value = volumeControl.value;
    });

    // EQ
    bassControl.addEventListener("input", () => {
      bassEQ.gain.value = bassControl.value;
    });
    midControl.addEventListener("input", () => {
      midEQ.gain.value = midControl.value;
    });
    trebleControl.addEventListener("input", () => {
      trebleEQ.gain.value = trebleControl.value;
    });

    // ビジュアライザー
    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");
    analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);

    function draw() {
      requestAnimationFrame(draw);
      analyser.getByteFrequencyData(dataArray);
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const barWidth = (canvas.width / bufferLength) * 2.5;
      let x = 0;
      for (let i = 0; i < bufferLength; i++) {
        const barHeight = dataArray[i];
        ctx.fillStyle = "rgb(" + (barHeight + 100) + ",50,50)";
        ctx.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);
        x += barWidth + 1;
      }
    }
    draw();
  </script>
</body>
</html>
